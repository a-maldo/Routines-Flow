<!--
========================================
üèÖ Routines Flow (nombre del juego)
Versi√≥n: v0.23.0
Estado: Estable ‚Äî Pre-lanzamiento interno
Desarrollado para: Turabo Gymnastics Center (TGC)
Autor: Axel Maldonado ‚Äî Proyecto TGC Games
Fecha: 2025-10-07

Descripci√≥n:
Juego educativo inspirado en las rutinas de gimnasia art√≠stica femenina del TGC.
La jugadora debe tocar las destrezas en el ritmo correcto para sumar puntos.

Notas de esta versi√≥n (v0.23.0):
- Compatibilidad y rendimiento: soporte de prefers-reduced-motion, teclado 1‚Äì4, aria-live.
- Modos r√°pidos: üîã Ahorro (reduce sombras y carga) y üåì Alto contraste.
- URL params: ?ap=salto&lv=basico&name=Valentina para precargar opciones.
- Progreso robusto (evita NaN%), peque√±os fixes de estabilidad.
- Mantiene: spawn separado (1 nota por intervalo), reanudar desde pausa, z-index targets, listeners unificados.
========================================
-->

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0f172a"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="color-scheme" content="light dark"/>
<title>Routines Flow ‚Äî TGC (v0.23.0)</title>

<style>
  :root{
    --brand:#0f172a; --bg2:#f6f8fb; --ink:#0b1220;
    --accent:#ec4899;      /* piso */
    --accent-alt:#f59e0b;  /* viga */
    --accent-salto:#10b981;/* salto */
    --accent-barra:#6366f1;/* barra */
    --radius:20px; --safe:max(16px, env(safe-area-inset-bottom, 16px));

    /* v0.23.0 sombras y contraste */
    --shadow: 0 8px 28px rgba(0,0,0,.08);
    --shadow-strong: 0 10px 22px rgba(15,23,42,.18);
    --note-shadow: 0 8px 18px rgba(0,0,0,.18);
    --contrast-ink: var(--ink);
    --contrast-bg: #fff;
  }

  *{box-sizing:border-box}
  html,body{overscroll-behavior:none; touch-action:manipulation;}
  body{margin:0;background:var(--bg2);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;display:flex;justify-content:center;padding:8px;min-height:100dvh}
  .game{position:relative;width:100%;max-width:500px;height:calc(100dvh - 16px);max-height:920px;border-radius:var(--radius);background:linear-gradient(#fff,#F2F5FA);overflow:hidden;border:1px solid #e5e7eb;box-shadow:var(--shadow)}

  .topbar{position:absolute;left:0;right:0;top:0;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;z-index:30;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.6));border-bottom:1px solid #eef2f7}
  .title{font-weight:800;font-size:14px}
  .chip{background:#eef2f7;border-radius:999px;padding:4px 8px;font-size:12px}
  .btn-icon{border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:10px;cursor:pointer}

  .stage{position:absolute;left:10px;right:10px;top:56px;bottom:130px;border-radius:18px;border:1px solid #fff;background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.72));overflow:hidden}
  .lanes{position:absolute;inset:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .lane{position:relative;background:rgba(255,255,255,.7);border:1px solid #fff;border-radius:16px;overflow:visible}

  .note{position:absolute;left:50%;transform:translateX(-50%);border-radius:999px;color:#fff;font-weight:800;font-size:13px;padding:8px 14px;box-shadow:var(--note-shadow);border:1px solid rgba(255,255,255,.35);user-select:none;cursor:pointer;max-width:180px;text-align:center;will-change:transform}
  .note.piso{background:var(--accent)} .note.viga{background:var(--accent-alt)}
  .note.salto{background:var(--accent-salto)} .note.barra{background:var(--accent-barra)}

  .target{position:absolute;left:50%;transform:translateX(-50%);width:78%;max-width:170px;display:flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:999px;background:#0f172a;color:#fff;font-weight:900;box-shadow:var(--shadow-strong);user-select:none;cursor:pointer;z-index:20;transition:transform .08s ease}
  .target b{font-size:20px;line-height:1}
  @keyframes bounceTap{0%{transform:translateX(-50%) scale(1)}40%{transform:translateX(-50%) scale(.92) translateY(1px)}100%{transform:translateX(-50%) scale(1)}}
  .target.bounce{animation:bounceTap .18s ease}

  .hitline-global{position:absolute;left:10px;right:10px;height:6px;border-radius:999px;background:#3b82f6;z-index:15;transition:background-color .22s ease}
  .hitline-perfect{background:#22c55e!important}.hitline-good{background:#eab308!important}.hitline-miss{background:#ef4444!important}
  @keyframes flashLine{0%{box-shadow:0 0 0 0 rgba(255,255,255,.45)}100%{box-shadow:0 0 20px 8px rgba(255,255,255,0)}}
  .hitline-flash{animation:flashLine .28s ease}

  .panel{position:absolute;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -12px 24px rgba(0,0,0,.06);border-top:1px solid #eef2f7;padding:14px;z-index:25;padding-bottom:var(--safe)}
  .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;padding:12px}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pillset{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 12px;border-radius:999px;background:#e6e9f2;color:#111827;font-weight:700;font-size:12px;border:1px solid #e5e7eb;cursor:pointer}
  .pill.on{background:#0f172a;color:#fff;border-color:#0f172a}
  .field{display:flex;flex-direction:column;gap:6px}
  .input{padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .cta{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid #0f172a;background:#0f172a;color:#fff;font-weight:900;cursor:pointer;box-shadow:0 4px 14px rgba(15,23,42,.18)}
  .btn.alt{background:#f3f6fb;color:#0f172a;border-color:#e5e7eb}

  .leaderboard{margin-top:10px;border:1px solid #eef2f7;border-radius:14px;background:#fff;overflow:hidden}
  .leaderboard h4{margin:0;padding:10px 12px;font-size:13px;background:#f8fafc;border-bottom:1px solid #eef2f7}
  .leaderboard table{width:100%;border-collapse:collapse}
  .leaderboard thead th{background:#ffffff;font-weight:800;color:#0b1220}
  .leaderboard td,.leaderboard th{padding:10px 12px;font-size:13px;border-top:1px solid #f1f5f9;text-align:left;white-space:nowrap}
  .leaderboard tbody tr:nth-child(even){background:#f8fafc}
  .leaderboard .pos{width:36px;text-align:center}

  .results{position:absolute;inset:0;background:rgba(255,255,255,.96);display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;z-index:40;padding-bottom:var(--safe)}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .kpi{padding:10px;border:1px solid #e5e7eb;border-radius:12px}
  .ok{background:#ecfdf5}.warn{background:#fff7ed}.bad{background:#fef2f2}
  .medal{margin-top:8px;font-weight:900}
  .actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;justify-content:center}

  .progress{position:absolute;left:12px;right:12px;bottom:12px;height:10px;border-radius:999px;background:#e2e8f0;overflow:hidden}
  .progress>div{height:100%;width:0%}

  .float{position:absolute;left:50%;transform:translateX(-50%);font-weight:900;font-size:12px;padding:4px 8px;border-radius:999px;color:#fff;pointer-events:none;opacity:.95;animation:upFade .6s ease-out forwards}
  .float.perfect{background:#22c55e}.float.good{background:#f59e0b}.float.miss{background:#ef4444}
  @keyframes upFade{0%{opacity:0;transform:translate(-50%,6px)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-28px)}}

  .pausedMask{position:absolute;inset:0;background:rgba(15,23,42,.35);color:#fff;display:none;align-items:center;justify-content:center;z-index:35;backdrop-filter:blur(1px)}
  .pausedMask .box{background:rgba(15,23,42,.9);padding:16px 20px;border-radius:14px;font-weight:900;display:flex;flex-direction:column;gap:10px;align-items:center}
  .pausedMask .box button{border:1px solid #fff;background:#10b981;color:#fff;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}

  /* Alto contraste (toggle) */
  :root.high-contrast{
    --contrast-ink:#0b0b0b;
    --contrast-bg:#ffffff;
  }
  :root.high-contrast .panel,
  :root.high-contrast .card,
  :root.high-contrast .leaderboard,
  :root.high-contrast .stage{ background:var(--contrast-bg) !important; color:var(--contrast-ink) !important; }
  :root.high-contrast .pill{ background:#e2e8f0; color:#0b1220; }

  /* Ahorro (toggle) reduce sombras */
  :root.power-save .game,
  :root.power-save .target,
  :root.power-save .note{ box-shadow:none !important; }

  /* Usuarios con reduce motion: desactivar animaciones decorativas */
  @media (prefers-reduced-motion: reduce){
    .target.bounce{ animation:none !important; }
    .float{ animation:none !important; opacity:1; }
    .hitline-flash{ animation:none !important; }
    *{scroll-behavior:auto;}
  }

  /* dvh fallback para iOS antiguos */
  @supports(height: 100dvh){
    .game{ height:calc(100dvh - 16px); }
  }

  @media (max-width:380px){.title{font-size:13px}.chip{font-size:11px;padding:3px 8px}.target b{font-size:18px}}
</style>
</head>
<body>
<div class="game" id="game">
  <div class="topbar">
    <div class="title">‚≠ê Routines Flow ‚Äî <span id="apparatusLabel">Salto</span></div>
    <div class="hud">
      <span class="chip" id="levelBadge">BABY GYM</span>
      <span class="chip">Puntaje: <b id="score">0</b></span>
      <button class="btn-icon" id="muteBtn" title="Sonido" type="button" aria-label="Silenciar o activar sonido" aria-pressed="false"><span id="muteIcon">üîä</span></button>
      <button class="btn-icon" id="pauseBtn" title="Pausar" type="button">‚è∏</button>
      <button class="btn-icon" id="restartBtn" title="Reiniciar" type="button">üîÅ</button>
    </div>
  </div>

  <div class="stage">
    <div class="lanes" id="lanes"></div>
    <div class="hitline-global" id="hitline"></div>
  </div>

  <div class="panel" id="panel">
    <div class="card stack">
      <div class="row">
        <div class="field" style="flex:1 1 160px">
          <label>Nombre</label>
          <input class="input" id="playerName" placeholder="Gimnasta"/>
        </div>
        <div class="field" style="flex:1 1 260px">
          <label>Aparato (orden fijo)</label>
          <div class="pillset" id="apPills">
            <button class="pill on" data-ap="salto" type="button">Salto</button>
            <button class="pill"    data-ap="barra" type="button">Barra</button>
            <button class="pill"    data-ap="viga"  type="button">Viga</button>
            <button class="pill"    data-ap="piso"  type="button">Piso</button>
          </div>
        </div>
        <div class="field" style="flex:1 1 220px">
          <label>Nivel (desarrollo)</label>
          <div class="pillset" id="lvPills">
            <button class="pill on" data-lv="baby"       type="button">Baby Gym</button>
            <button class="pill"    data-lv="basico"     type="button">B√°sico</button>
            <button class="pill"    data-lv="intermedio" type="button">Intermedio</button>
          </div>
        </div>
      </div>

      <!-- v0.23.0: toggles r√°pidos -->
      <div class="row">
        <div class="pillset" aria-label="Ajustes r√°pidos" role="group">
          <button class="pill" id="togglePowerSave" type="button">üîã Ahorro</button>
          <button class="pill" id="toggleContrast"  type="button">üåì Alto contraste</button>
        </div>
      </div>

      <div class="cta">
        <button class="btn alt" id="continueLast" type="button" style="display:none">Continuar √∫ltimo</button>
        <button class="btn" id="startBtn" type="button">Comenzar</button>
      </div>
    </div>

    <div class="leaderboard" id="lb">
      <h4>üèÜ Ranking (Top 10 por aparato + nivel)</h4>
      <div style="overflow:auto;max-height:180px">
        <table id="lbTable"><thead><tr><th class="pos">#</th><th>Nombre</th><th>Puntaje</th><th>Premio</th><th>Fecha</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="cta" style="margin:10px 12px">
        <button class="btn alt" id="resetLB" type="button">Reiniciar ranking actual</button>
      </div>
    </div>
  </div>

  <div class="results" id="results" role="dialog" aria-live="polite" aria-modal="true">
    <div style="font-size:24px;font-weight:900">¬°Gran rutina, <span id="rName">Gimnasta</span>!</div>
    <div class="kpis">
      <div class="kpi ok"><b id="rPerfect">0</b><div class="subtitle">Perfect</div></div>
      <div class="kpi warn"><b id="rGood">0</b><div class="subtitle">Good</div></div>
      <div class="kpi bad"><b id="rMiss">0</b><div class="subtitle">Miss</div></div>
    </div>
    <div class="medal" id="medal"></div>
    <div style="font-size:40px;font-weight:900;margin-top:8px" id="rScore">0</div>
    <div class="actions">
      <button class="btn" id="playAgain" type="button">Jugar de nuevo</button>
      <button class="btn" id="nextEvent" type="button" style="background:#2563eb;border-color:#2563eb">Siguiente evento</button>
      <button class="btn alt" id="toMain" type="button">Men√∫ principal</button>
    </div>
  </div>

  <div class="pausedMask" id="pausedMask">
    <div class="box" id="pauseBox">
      <div>PAUSA</div>
      <button id="resumeBtn" type="button">Reanudar ‚ñ∂</button>
    </div>
  </div>

  <div class="progress"><div id="progBar"></div></div>
</div>

<script>
/* ===== Routines Flow ‚Äî v0.23.0 ===== */
const el=id=>document.getElementById(id), qsa=s=>[...document.querySelectorAll(s)];
const LS={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
const esc=s=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* Orden y datos base */
const ORDER=['salto','barra','viga','piso'];
const APP={salto:{label:'Salto',theme:'salto',color:'#10b981'}, barra:{label:'Barra',theme:'barra',color:'#6366f1'}, viga:{label:'Viga',theme:'viga',color:'#f59e0b'}, piso:{label:'Piso',theme:'piso',color:'#ec4899'}};
const LEVELS={baby:{label:'Baby Gym',spawnMs:1400,fallMs:5800,target:12}, basico:{label:'B√°sico',spawnMs:1000,fallMs:3600,target:16}, intermedio:{label:'Intermedio',spawnMs:800,fallMs:2600,target:20}};
const MOVES={
  piso:{baby:['Rodada','Vela','Salto estrella','Giro 1/4','Relev√©','Paso chass√©','Pose final'],basico:['Rondada','Salto split','Giro en pass√©','Serie chass√©','Arabesque','Salto C','Salida'],intermedio:['Rondada-flick','Giro 1/1','Salto split 120¬∞','Serie acro corta','Straddle Jump','Coreo','Salida']},
  viga:{baby:['Subida segura','Paso lateral','Relev√©','Balance T','Giro 1/4','Desmonte abajo'],basico:['Montada frontal','Passe','Pivot 1/2','Scale','Dip','Desmonte'],intermedio:['Montada salto','Pivot 1/1','Cartwheel','Serie equilibrio','Relev√© largo','Dismount con giro']},
  salto:{baby:['Carrera suave','Tabla manos','Bote ligero','Aterrizaje con stick'],basico:['Carrera','Preflight','Repulsi√≥n','Aterrizaje controlado'],intermedio:['Carrera r√°pida','Preflight potente','Bloqueo/Repulsi√≥n','Aterrizaje con stick']},
  barra:{baby:['Colgante','Balanceo suave','Apoyo codo','Bajarse seguro'],basico:['Pullover','Cast peque√±o','Tap swing','Desmonte b√°sico'],intermedio:['Cast medio','Tap swing alto','Cambio de agarre','Desmonte con giro']}
};

/* Geometr√≠a */
const LANES=4, HIT_Y=88, LINE_OFFSET=64, LINE_Y=HIT_Y+LINE_OFFSET, MISS_LINE_Y=HIT_Y-8, LANE_SPAN=560;
const PERFECT_RADIUS=18, GOOD_RADIUS=40;

/* Flags runtime v0.23.0 */
let powerSave = LS.get('rf22:power', false);
let highContrast = LS.get('rf22:contrast', false);
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

/* Estado */
let apparatus=LS.get('rf22:ap','salto');
let level=LS.get('rf22:lv','baby');
let running=false, paused=false, ended=false, startTs=null, timeline=0, raf=0;
let notes=[], hits={perfect:0,good:0,miss:0}, score=0, laneHits=[0,0,0,0];
let totalTarget=LEVELS[level].target, spawned=0, processed=0, nextSpawnAt=1400, spawnIntervalMs=LEVELS[level].spawnMs;

/* Refs UI */
const lanesWrap=el('lanes'), hitline=el('hitline'), progBar=el('progBar'), pausedMask=el('pausedMask'), pauseBox=el('pauseBox'), resumeBtn=el('resumeBtn');
const scoreEl=el('score'), levelBadge=el('levelBadge'), apparatusLabel=el('apparatusLabel');
const panel=el('panel'), results=el('results'), rName=el('rName'), rScore=el('rScore'), rPerfect=el('rPerfect'), rGood=el('rGood'), rMiss=el('rMiss'), medalEl=el('medal');
const startBtn=el('startBtn'), restartBtn=el('restartBtn'), pauseBtn=el('pauseBtn'), muteBtn=el('muteBtn'), muteIcon=el('muteIcon');
const playAgain=el('playAgain'), nextEvent=el('nextEvent'), toMain=el('toMain'), continueLastBtn=el('continueLast');
const nameInput=el('playerName'), apPills=el('apPills'), lvPills=el('lvPills');
const lbTable=el('lbTable'), lbBody=lbTable?lbTable.querySelector('tbody'):null, resetLBBtn=el('resetLB');

/* Audio */
const SFX=(()=>{let ctx=null,muted=LS.get('rf22:muted',false);
  const ensure=()=>{if(!ctx)ctx=new (window.AudioContext||window.webkitAudioContext)();return ctx};
  const tone=(f=880,d=.06,type='sine',vol=.22)=>{if(muted)return;const c=ensure(),o=c.createOscillator(),g=c.createGain();o.type=type;o.frequency.value=f;o.connect(g);g.connect(c.destination);const t=c.currentTime;g.gain.setValueAtTime(.001,t);g.gain.exponentialRampToValueAtTime(vol,t+.01);g.gain.exponentialRampToValueAtTime(.001,t+d);o.start();o.stop(t+d)};
  function setMuted(v){muted=!!v;LS.set('rf22:muted',muted);muteIcon.textContent=muted?'üîá':'üîä';muteBtn.setAttribute('aria-pressed',String(muted));}
  return {perfect:()=>tone(1046,.06,'square',.25),good:()=>tone(784,.06,'triangle',.22),miss:()=>tone(196,.08,'sawtooth',.18),resume:()=>{try{ensure().resume()}catch(_){}} ,setMuted,isMuted:()=>muted};
})();
window.addEventListener('pointerdown',()=>SFX.resume(),{once:true});
muteIcon.textContent=SFX.isMuted()?'üîá':'üîä'; muteBtn.setAttribute('aria-pressed',String(SFX.isMuted()));
function buzz(ms){try{if(navigator.vibrate) navigator.vibrate(ms);}catch(_){}}  

/* Carriles */
let laneEls=[];
function buildLanes(){
  lanesWrap.innerHTML=''; laneEls.length=0;
  for(let l=0;l<LANES;l++){
    const lane=document.createElement('div'); lane.className='lane';
    const target=document.createElement('button'); target.className='target'; target.type='button'; target.style.bottom=(HIT_Y-18)+'px';
    target.innerHTML=`<b class="laneCount">0</b>`;
    target.addEventListener('pointerdown',e=>{e.preventDefault();target.classList.add('bounce');setTimeout(()=>target.classList.remove('bounce'),180);judge(l);},{passive:false});
    lane.appendChild(target); lanesWrap.appendChild(lane); laneEls.push(lane);
  }
  hitline.style.bottom=(LINE_Y-3)+'px';
}
buildLanes();

/* UI Helpers */
function colorizeProgress(){const map={piso:'var(--accent)',viga:'var(--accent-alt)',salto:'var(--accent-salto)',barra:'var(--accent-barra)'};progBar.style.background=getComputedStyle(document.documentElement).getPropertyValue(map[apparatus])||APP[apparatus].color;}
function refreshBadges(){apparatusLabel.textContent=APP[apparatus].label;levelBadge.textContent=LEVELS[level].label.toUpperCase();colorizeProgress();}
function updateLaneCounters(onlyLane){if(onlyLane===undefined){for(let l=0;l<LANES;l++){const t=laneEls[l]?.querySelector('.laneCount'); if(t) t.textContent=laneHits[l];}}else{const t=laneEls[onlyLane]?.querySelector('.laneCount'); if(t) t.textContent=laneHits[onlyLane];}}
function applyModes(){document.documentElement.classList.toggle('power-save', !!powerSave);document.documentElement.classList.toggle('high-contrast', !!highContrast);}
function initUI(){
  nameInput.value=LS.get('rf22:name','Gimnasta');
  qsa('#apPills .pill').forEach(p=>p.classList.toggle('on',p.dataset.ap===apparatus));
  qsa('#lvPills .pill').forEach(p=>p.classList.toggle('on',p.dataset.lv===level));
  refreshBadges();updateLaneCounters();renderLeaderboard();
  continueLastBtn.style.display=LS.get('rf22:last:run',null)?'':'';
  // toggles
  document.getElementById('togglePowerSave')?.classList.toggle('on', powerSave);
  document.getElementById('toggleContrast')?.classList.toggle('on', highContrast);
}
applyModes();
initUI();

/* Leaderboard */
function lbKey(){return `rf22:lb:${apparatus}:${level}`;}
function saveLeaderboard(medal,emoji){const k=lbKey();const cur=LS.get(k,[]);cur.push({name:nameInput.value||'Gimnasta',score,medal,medalEmoji:emoji,date:new Date().toISOString()});cur.sort((a,b)=>b.score-a.score);cur.splice(10);LS.set(k,cur);}
function renderLeaderboard(){if(!lbBody)return;const data=LS.get(lbKey(),[]);lbBody.innerHTML='';data.forEach((r,i)=>{const tr=document.createElement('tr');const premio=(r.medalEmoji||'')+' '+(r.medal?(r.medal[0].toUpperCase()+r.medal.slice(1)):'');tr.innerHTML=`<td class="pos">${i+1}</td><td>${esc(r.name)}</td><td>${r.score}</td><td>${premio}</td><td>${new Date(r.date).toLocaleDateString()}</td>`;lbBody.appendChild(tr);});}
if(resetLBBtn){resetLBBtn.onclick=()=>{if(confirm('¬øReiniciar el ranking local para este aparato y nivel?')){LS.set(lbKey(),[]);renderLeaderboard();}}}

/* Progreso */
function updateProgressBar(){
  const pct = totalTarget ? Math.min(100, Math.max(0, (processed/totalTarget)*100)) : 0;
  progBar.style.width = pct.toFixed(2) + '%';
}

/* URL params ‚Üí ?ap=salto&lv=basico&name=Valentina */
(function parseParams(){
  try{
    const u = new URL(location.href);
    const ap = u.searchParams.get('ap');
    const lv = u.searchParams.get('lv');
    const nm = u.searchParams.get('name');
    if(ap && APP[ap]) { apparatus = ap; LS.set('rf22:ap', ap); }
    if(lv && LEVELS[lv]) { level = lv; LS.set('rf22:lv', lv); }
    if(nm){ LS.set('rf22:name', nm); }
  }catch(_){}
})();

/* Spawning helpers considerando powerSave (sin mutar LEVELS) */
function effectiveSpawnMs(){
  const base = LEVELS[level].spawnMs;
  return Math.round(base * (powerSave ? 1.10 : 1));
}
function effectiveFallMsBase(){
  const base = LEVELS[level].fallMs;
  return Math.round(base * (powerSave ? 1.05 : 1));
}

/* Notas ‚Äî una por intervalo; varias visibles por ca√≠da */
function currentMoves(){return (MOVES[apparatus]&&MOVES[apparatus][level])?MOVES[apparatus][level]:MOVES.salto.baby;}
function genNextNote(timeBase){
  if(spawned>=totalTarget) return [];
  const moves=currentMoves();
  const lane=Math.floor(Math.random()*LANES);
  const id=(spawned+1);
  spawned++;
  return [{id,time:timeBase,lane,label:moves[(id+lane)%moves.length],hit:false,el:null}];
}
function fallMsNow(){
  const base=effectiveFallMsBase();
  const p=totalTarget?Math.min(1,processed/totalTarget):0;
  return Math.max(400, base*(1-0.20*p)); // clamp m√≠nimo
}
function noteY(n,now){
  const lead=1100, t0=n.time-lead;
  const k=(now-t0)/fallMsNow();
  return HIT_Y + (1-k)*LANE_SPAN;
}
function purgeNotesDOM(){qsa('.note').forEach(x=>x.remove());for(const n of notes){if(n.el){try{n.el.remove()}catch(_){}}}notes=[];}

/* Loop */
function loop(ts){
  if(!running) return;
  if(!startTs) startTs = ts || performance.now();
  const now = ts || performance.now();
  timeline = now - startTs;

  if(!paused){
    // Generar 1 nota por intervalo espaciado
    while(spawned<totalTarget && timeline>=nextSpawnAt){
      notes = notes.concat(genNextNote(nextSpawnAt));
      nextSpawnAt += spawnIntervalMs; // usa intervalo efectivo
    }
    updateNotes();
    if(processed>=totalTarget && notes.length===0){ endGame(); return; }
  }
  raf = requestAnimationFrame(loop);
}

/* Control */
function startGame(){
  if(raf) cancelAnimationFrame(raf);
  purgeNotesDOM();
  ended=false; running=true; paused=false; pauseBtn.textContent='‚è∏'; pausedMask.style.display='none';
  LS.set('rf22:name',nameInput.value||'Gimnasta'); LS.set('rf22:ap',apparatus); LS.set('rf22:lv',level);
  hits={perfect:0,good:0,miss:0}; score=0; laneHits=[0,0,0,0];
  totalTarget=LEVELS[level].target; spawned=0; processed=0;
  spawnIntervalMs = effectiveSpawnMs();
  nextSpawnAt = spawnIntervalMs; // primera nota al tama√±o del intervalo
  updateProgressBar();
  updateLaneCounters(); updateHUD();

  startTs=null; timeline=0; progBar.style.width='0%';
  results.style.display='none'; panel.style.display='none';
  resetLine(); requestAnimationFrame(loop);
}
function endGame(){
  running=false; ended=true; if(raf) cancelAnimationFrame(raf);
  purgeNotesDOM();
  const totalHit=hits.perfect+hits.good+hits.miss, acc= totalHit? (hits.perfect/totalHit):0;
  const medal= acc>=0.8?'oro': acc>=0.55?'plata':'bronce';
  const emoji= medal==='oro'?'ü•á': medal==='plata'?'ü•à':'ü•â';
  medalEl.textContent=`${emoji} ${medal[0].toUpperCase()+medal.slice(1)}`;
  rName.textContent=nameInput.value||'Gimnasta';
  rScore.textContent=score; rPerfect.textContent=hits.perfect; rGood.textContent=hits.good; rMiss.textContent=hits.miss;
  results.style.display='flex'; saveLeaderboard(medal,emoji); renderLeaderboard(); saveLastRun();
}

/* Render */
function updateNotes(){
  const now=timeline; const keep=[];
  for(const n of notes){
    const y = noteY(n, now);
    if(!n.hit && y <= MISS_LINE_Y){
      n.hit=true; processed++; if(n.el){n.el.remove(); n.el=null;}
      hits.miss++; flashLine('miss'); floatText(n.lane,'Miss','miss'); SFX.miss(); buzz(40);
      updateHUD(); updateProgressBar(); continue;
    }
    if(!n.hit){
      if(!n.el){
        const b=document.createElement('div'); b.className='note '+APP[apparatus].theme; b.textContent=n.label;
        b.addEventListener('pointerdown',e=>{e.preventDefault();judge(n.lane);},{passive:false});
        laneEls[n.lane].appendChild(b); n.el=b;
      }
      n.el.style.bottom=Math.max(10,y)+'px'; keep.push(n);
    }
  }
  notes=keep;
}

/* Judge */
function judge(lane){
  if(!running || paused || ended) return;
  const now=timeline;
  const cand=notes.filter(n=>n.lane===lane && !n.hit).map(n=>({n,y:noteY(n,now)})).sort((a,b)=>Math.abs(a.y-LINE_Y)-Math.abs(b.y-LINE_Y))[0];
  if(!cand) return;
  const {n,y}=cand, dy=Math.abs(y-LINE_Y);
  if(dy>GOOD_RADIUS) return;
  n.hit=true; processed++; if(n.el){n.el.remove(); n.el=null;}
  const kind=(dy<=PERFECT_RADIUS)?'perfect':'good';
  if(kind==='perfect'){hits.perfect++;score+=100;SFX.perfect();buzz(18);}else{hits.good++;score+=60;SFX.good();buzz(12);}
  laneHits[lane]++; updateLaneCounters(lane); flashLine(kind); floatText(lane, kind==='perfect'?'Perfect +100':'Good +60', kind); updateHUD(); updateProgressBar();
}

/* Feedback l√≠nea */
let lineTimer=0; function resetLine(){hitline.className='hitline-global';}
function flashLine(kind){
  resetLine();
  hitline.classList.add(kind==='perfect'?'hitline-perfect':kind==='good'?'hitline-good':'hitline-miss');
  if(!prefersReduced){ hitline.classList.add('hitline-flash'); }
  clearTimeout(lineTimer); lineTimer=setTimeout(resetLine,300);
}
function floatText(lane,text,kind){
  const ln=laneEls[lane];const s=document.createElement('div');
  s.className=`float ${kind}`; s.style.bottom=(LINE_Y+12)+'px'; s.textContent=text; ln.appendChild(s);
  setTimeout(()=>{ try{s.remove()}catch(_){}} , prefersReduced ? 1 : 650);
}

/* HUD + progreso */
function updateHUD(){scoreEl.textContent=score;}

/* √öltimo run */
function saveLastRun(){LS.set('rf22:last:run',{when:Date.now(),apparatus,level,score,hits});}
function restoreLastRun(){const r=LS.get('rf22:last:run',null);if(!r)return false;apparatus=r.apparatus||apparatus;level=r.level||level;return true;}

/* Navegaci√≥n */
function nextApparatus(){const idx=ORDER.indexOf(apparatus);apparatus=ORDER[(idx+1)%ORDER.length];LS.set('rf22:ap',apparatus);refreshBadges();}
function goToMain(){results.style.display='none';panel.style.display='';score=0;hits={perfect:0,good:0,miss:0};updateHUD();}

/* Listeners UI */
startBtn.onclick=startGame;
restartBtn.onclick=()=>startGame();
pauseBtn.onclick=()=>{ if(!running) return; paused=!paused; pauseBtn.textContent=paused?'‚ñ∂':'‚è∏'; pausedMask.style.display=paused?'flex':'none';
  if(!paused){const now=performance.now();startTs=now - timeline;resetLine();requestAnimationFrame(loop);}else if(raf){cancelAnimationFrame(raf);} };
resumeBtn.onclick=()=>pauseBtn.click();
pausedMask.addEventListener('pointerdown',()=>{ if(paused) pauseBtn.click(); });
pauseBox.addEventListener('pointerdown',e=>e.stopPropagation());

muteBtn.onclick=()=>SFX.setMuted(!SFX.isMuted());
playAgain.onclick=()=>startGame();
nextEvent.onclick=()=>{nextApparatus();startGame();};
toMain.onclick=()=>goToMain();
continueLastBtn.onclick=()=>{if(restoreLastRun()){qsa('#apPills .pill').forEach(p=>p.classList.toggle('on',p.dataset.ap===apparatus));qsa('#lvPills .pill').forEach(p=>p.classList.toggle('on',p.dataset.lv===level));refreshBadges();startGame();}};

/* Aparato/Nivel */
apPills.addEventListener('pointerdown',e=>{const b=e.target.closest('.pill'); if(!b)return; qsa('#apPills .pill').forEach(p=>p.classList.remove('on')); b.classList.add('on'); apparatus=b.dataset.ap; LS.set('rf22:ap', apparatus); refreshBadges(); renderLeaderboard();},{passive:true});
lvPills.addEventListener('pointerdown',e=>{const b=e.target.closest('.pill'); if(!b)return; qsa('#lvPills .pill').forEach(p=>p.classList.remove('on')); b.classList.add('on'); level=b.dataset.lv; LS.set('rf22:lv',level); levelBadge.textContent=LEVELS[level].label.toUpperCase(); totalTarget=LEVELS[level].target; spawnIntervalMs = effectiveSpawnMs(); renderLeaderboard();},{passive:true});
nameInput.onchange=()=>LS.set('rf22:name',nameInput.value||'Gimnasta');

/* Teclado: 1‚Äì4 disparan carriles */
window.addEventListener('keydown',(e)=>{
  if(!running || paused || ended) return;
  const map={'1':0,'2':1,'3':2,'4':3};
  if(e.key in map){ e.preventDefault(); judge(map[e.key]); }
},{passive:false});

/* Toggles r√°pidos */
const togglePower = el('togglePowerSave');
const toggleContrast = el('toggleContrast');
if(togglePower){
  togglePower.onclick = () => {
    powerSave = !powerSave; LS.set('rf22:power', powerSave);
    togglePower.classList.toggle('on', powerSave); applyModes();
    // recalcular intervalos si est√° en men√∫
    spawnIntervalMs = effectiveSpawnMs();
  };
}
if(toggleContrast){
  toggleContrast.onclick = () => {
    highContrast = !highContrast; LS.set('rf22:contrast', highContrast);
    toggleContrast.classList.toggle('on', highContrast); applyModes();
  };
}

/* Auto-pausa al perder foco */
document.addEventListener('visibilitychange',()=>{ if(document.hidden && running && !paused) pauseBtn.click(); });

/* Inicial */
(function(){
  // Asegura colores de progreso y leaderboard visibles
  colorizeProgress();
  renderLeaderboard();
  continueLastBtn.style.display=LS.get('rf22:last:run',null)?'':'';
})();
</script>
</body>
</html>
